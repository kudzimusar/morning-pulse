name: Deploy WhatsApp Bot to Google Cloud Functions

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger

# Define necessary permissions for the workflow to interact with OIDC and GCP
permissions:
  contents: 'read'
  id-token: 'write'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} # Your Google Cloud Project ID
  FUNCTION_NAME: webhook
  REGION: us-central1
  ENTRY_POINT: webhook

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # *** FIX: Removed problematic 'if' condition that failed parsing. ***
    # The job will now run, and secrets are checked in the authentication step.

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Remove ALL frontend files BEFORE installing dependencies to prevent build confusion
      - name: Remove frontend files that confuse Cloud Functions build
        run: |
          echo "Removing frontend files..."
          rm -f index.html
          rm -f *.html
          rm -rf components/
          rm -rf services/
          rm -f App.tsx index.tsx vite.config.ts tsconfig.json metadata.json constants.ts types.ts
          echo "Frontend files removed. Remaining files:"
          ls -la

      # Install dependencies (required for deployment)
      - name: Install Dependencies
        run: npm install

      # Authenticate to Google Cloud using the Service Account Key
      - name: Authenticate Google Cloud with Service Account Key
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # Setup gcloud SDK
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Enable required APIs
      - name: Enable Cloud Functions API
        run: |
          gcloud services enable cloudfunctions.googleapis.com --project=${{ env.PROJECT_ID }}
          gcloud services enable cloudbuild.googleapis.com --project=${{ env.PROJECT_ID }}
          gcloud services enable artifactregistry.googleapis.com --project=${{ env.PROJECT_ID }}

      # Verify index.html is gone before deployment
      - name: Verify deployment files
        run: |
          echo "Files in deployment directory:"
          ls -la
          if [ -f index.html ]; then
            echo "ERROR: index.html still exists!"
            exit 1
          fi
          if [ ! -f index.js ]; then
            echo "ERROR: index.js not found!"
            exit 1
          fi
          echo "✓ Deployment files verified"

      # Deploy the Cloud Function
      - name: Deploy Cloud Function
        uses: google-github-actions/deploy-cloud-functions@v2
        id: deploy
        with:
          name: ${{ env.FUNCTION_NAME }}
          runtime: nodejs20
          entry_point: ${{ env.ENTRY_POINT }}
          project_id: ${{ env.PROJECT_ID }}
          region: ${{ env.REGION }}
          source_dir: .
          memory_mb: 256
          timeout: 540s
          # This handles environment variables cleanly using the action's 'env_vars' input
          env_vars: |
            WHATSAPP_ACCESS_TOKEN=${{ secrets.WHATSAPP_ACCESS_TOKEN }}
            WHATSAPP_PHONE_ID=${{ secrets.WHATSAPP_PHONE_ID }}
            WHATSAPP_VERIFY_TOKEN=${{ secrets.WHATSAPP_VERIFY_TOKEN }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            FIREBASE_ADMIN_CONFIG=${{ secrets.GCP_SA_KEY }}
            APP_ID=morning-pulse-app

      # IMPORTANT: Output the final deployed URL for the user to configure the webhook
      - name: Print Final WebHook Configuration Instructions
        if: success()
        run: |
          echo "=========================================================================="
          echo "✅ DEPLOYMENT SUCCESSFUL! - WebHook URL:"
          echo "Copy the URL below and paste it into the Meta Developer Portal's Webhook Configuration."
          echo "URL: ${{ steps.deploy.outputs.url }}"
          echo "Verification Token: ${{ secrets.WHATSAPP_VERIFY_TOKEN }}"
          echo "=========================================================================="
