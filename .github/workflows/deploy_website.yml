name: Deploy Website to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'website/**'
      - 'scripts/**'
      - '.github/workflows/deploy_website.yml'
  workflow_dispatch: # Allows manual trigger
  schedule:
    # Run daily at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  APP_ID: morning-pulse-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to avoid cache issues
          ref: main  # Explicitly specify the branch
      
      - name: Pull latest changes
        run: |
          git pull origin main || true
          git fetch --all
      
      - name: Log commit details
        run: |
          echo "=== COMMIT VERIFICATION ==="
          echo "Building commit: $GITHUB_SHA"
          echo "Branch: $GITHUB_REF"
          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "Commit message: $(git log -1 --pretty=%B)"
          echo "Full commit log:"
          git log -1
          echo "=== END COMMIT VERIFICATION ==="
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'website/package-lock.json'
      
      # Authenticate to Google Cloud for Firestore access
      - name: Authenticate Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      # Install script dependencies (for static generation)
      - name: Install Script Dependencies
        run: |
          cd functions
          npm install
      
      # Generate static news data from Firestore BEFORE building website
      # This writes to website/public/data/ which will be copied to dist during build
      - name: Generate Static News Data
        env:
          FIREBASE_ADMIN_CONFIG: ${{ secrets.GCP_SA_KEY }}
          APP_ID: ${{ env.APP_ID }}
          NODE_PATH: ${{ github.workspace }}/functions/node_modules
        run: |
          echo "üöÄ Running static site generation..."
          node scripts/generateStaticSite.js
          echo ""
          echo "üìÅ Checking generated files..."
          ls -lh website/public/data/ || echo "‚ö†Ô∏è  No data directory created"
        continue-on-error: true # Continue even if static generation fails
      
      # Install website dependencies
      - name: Install Website Dependencies
        run: |
          cd website
          npm ci
      
      # Build website (this will copy public/data to dist/data via Vite)
      - name: Build Website
        env:
          VITE_FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          cd website
          npm run build
          echo ""
          echo "üìÅ Checking build output..."
          ls -lh dist/
          ls -lh dist/data/ || echo "‚ö†Ô∏è  No data directory in dist"
      
      # Verify build output
      - name: Verify Build Output
        run: |
          echo "=== BUILD VERIFICATION ==="
          echo "Dist directory contents:"
          ls -lh website/dist/
          echo ""
          echo "Data directory contents:"
          ls -lh website/dist/data/ || echo "‚ö†Ô∏è  No data directory found"
          echo ""
          if [ -f website/dist/data/news-latest.json ]; then
            echo "‚úÖ news-latest.json exists"
            echo "File size: $(wc -c < website/dist/data/news-latest.json) bytes"
            echo "Preview:"
            head -20 website/dist/data/news-latest.json
          else
            echo "‚ö†Ô∏è  news-latest.json not found - site will fall back to Firestore"
          fi
          echo "=== END VERIFICATION ==="
      
      # Pre-render share pages with OG tags (AFTER build, writes to dist/shares/)
      - name: Generate Share Pages
        env:
          FIREBASE_ADMIN_CONFIG: ${{ secrets.GCP_SA_KEY }}
          APP_ID: ${{ env.APP_ID }}
          GITHUB_PAGES_URL: https://kudzimusar.github.io
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_PATH: ${{ github.workspace }}/functions/node_modules
        run: |
          echo "üöÄ Generating share pages with OG tags..."
          cd website
          node scripts/generate-shares.js
          echo ""
          echo "üìÅ Checking generated share pages..."
          ls -lh dist/ || echo "‚ö†Ô∏è  Dist directory check failed"
          ls -lh dist/shares/ || echo "‚ö†Ô∏è  No shares directory created"
          ls -lh dist/share.html || echo "‚ö†Ô∏è  share.html not created"
          ls -lh dist/.nojekyll || echo "‚ö†Ô∏è  .nojekyll not created"
          if [ -d dist/shares ]; then
            echo ""
            echo "Share pages generated:"
            find dist/shares -name "index.html" | head -10
            echo ""
            echo "Total share folders: $(find dist/shares -type d -mindepth 1 | wc -l)"
          fi
          if [ -f dist/share.html ]; then
            echo "‚úÖ Universal share.html created ($(wc -c < dist/share.html) bytes)"
          fi
          if [ -f dist/.nojekyll ]; then
            echo "‚úÖ .nojekyll file created"
          fi
        continue-on-error: true # Continue even if share generation fails
      
      # Setup Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      # Verify shares folder exists in artifact before upload
      - name: Verify Shares Folder in Artifact
        run: |
          echo "=== ARTIFACT VERIFICATION ==="
          echo "Checking dist directory structure:"
          ls -la website/dist/ || echo "‚ùå dist directory missing"
          echo ""
          echo "Checking for shares folder:"
          if [ -d website/dist/shares ]; then
            echo "‚úÖ shares folder exists"
            echo "Share folders count: $(find website/dist/shares -type d -mindepth 1 | wc -l)"
            echo "Share HTML files count: $(find website/dist/shares -name "index.html" | wc -l)"
            echo ""
            echo "Sample share folders:"
            find website/dist/shares -type d -mindepth 1 | head -5
            echo ""
            echo "Sample share files:"
            find website/dist/shares -name "index.html" | head -5
          else
            echo "‚ùå shares folder MISSING - this will cause 404s!"
          fi
          echo ""
          echo "Checking for .nojekyll:"
          if [ -f website/dist/.nojekyll ]; then
            echo "‚úÖ .nojekyll exists"
          else
            echo "‚ùå .nojekyll MISSING - GitHub Pages may ignore folders!"
          fi
          echo ""
          echo "Checking for share.html:"
          if [ -f website/dist/share.html ]; then
            echo "‚úÖ share.html exists ($(wc -c < website/dist/share.html) bytes)"
          else
            echo "‚ö†Ô∏è  share.html missing (optional)"
          fi
          echo "=== END VERIFICATION ==="
      
      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './website/dist'
      
      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      # Report deployment status
      - name: Report Deployment Status
        if: always()
        run: |
          echo "=== DEPLOYMENT COMPLETE ==="
          echo "Status: ${{ job.status }}"
          echo "Deployment URL: https://kudzimusar.github.io/morning-pulse/"
          echo "==========================="
