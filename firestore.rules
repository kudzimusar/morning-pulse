rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check for bootstrap UIDs that can bypass token-based role checks initially
    function isBootstrapUser() {
      return request.auth != null && (
        request.auth.uid == '2jnMK761RcMvag3Agj5Wx3HjwpJ2' || 
        request.auth.uid == 'VaGwarisa'
      );
    }
    
    function isSuperAdmin() {
      return request.auth != null && (
        request.auth.token.super_admin == true || 
        isBootstrapUser()
      );
    }
    
    function isBureauChief() {
      return request.auth != null && (
        request.auth.token.bureau_chief == true || 
        request.auth.token.super_admin == true ||
        isBootstrapUser()
      );
    }
    
    function isEditor() {
      return request.auth != null && (
        request.auth.token.editor == true || 
        request.auth.token.bureau_chief == true || 
        request.auth.token.super_admin == true ||
        isBootstrapUser()
      );
    }
    
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true || 
        request.auth.token.super_admin == true ||
        isBootstrapUser()
      );
    }
    
    function isWriter() {
      return request.auth != null && (
        request.auth.token.writer == true ||
        isEditor()
      );
    }
    
    function isOwner(resource) {
      return request.auth != null && (
        request.auth.uid == resource.data.authorId || 
        request.auth.uid == resource.data.uid ||
        request.auth.uid == resource.data.authorUid
      );
    }
    
    // --- Root Collections (New Standard) ---
    
    // Staff members
    match /staff/{staffId} {
      allow read: if isSignedIn() && (request.auth.uid == staffId || isBureauChief() || isAdmin());
      // Allow bootstrap users to create their own record, or Bureau Chiefs to update
      allow create: if isSignedIn() && (request.auth.uid == staffId && isBootstrapUser());
      allow update: if isSignedIn() && (isBureauChief() || request.auth.uid == staffId);
      allow delete: if isSuperAdmin();
    }
    
    // Writers profiles
    match /writers/{writerId} {
      allow read: if isSignedIn() && (request.auth.uid == writerId || isEditor());
      allow create: if isSignedIn() && request.auth.uid == writerId;
      allow update: if isSignedIn() && (request.auth.uid == writerId || isEditor());
      allow delete: if isBureauChief();
    }
    
    // Invitations
    match /invites/{token} {
      allow read: if true; // Tokens need to be readable by anyone to validate
      allow write: if isAdmin();
    }
    
    // Audit Logs
    match /auditLog/{logId} {
      allow read: if isBureauChief() || isAdmin();
      allow create: if isEditor(); // Staff can write logs
      allow update, delete: if false;
    }
    
    // Readers
    match /readers/{readerId} {
      allow read, write: if isSignedIn() && request.auth.uid == readerId;
    }
    
    // Newsletter Subscribers
    match /subscribers/{subscriberId} {
      allow read: if isSignedIn() && (isBureauChief() || isAdmin() || request.auth.uid == subscriberId);
      allow create: if true; // Public can subscribe
      allow update: if isSignedIn() && (request.auth.uid == subscriberId || isAdmin());
      allow delete: if isAdmin();
    }

    // --- Legacy/App-Specific Data ---
    match /artifacts/{appId} {
      // Allow read access to public data for everyone
      match /public/data/{document=**} {
        allow read: if true;
      }
      
      match /public/data/opinions/{opinionId} {
        allow read: if true;
        allow create: if isSignedIn(); // Allow submission from anyone signed in (anonymous or otherwise)
        allow update: if isSignedIn() && (isOwner(resource) || isEditor());
        allow delete: if isBureauChief();
      }
      
      match /public/data/pitches/{pitchId} {
        allow create: if isWriter();
        allow read: if isSignedIn() && (isOwner(resource) || isEditor());
        allow update, delete: if isSignedIn() && (isOwner(resource) || isEditor());
      }
      
      match /public/data/ads/{adId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && (isOwner(resource) || isAdmin());
        allow delete: if isAdmin();
      }
      
      match /public/data/adSlots/{slotId} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }
  }
}