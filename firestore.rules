rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- ðŸ‘‘ BOSS MODE (Global Bypass) ---
    // These specific UIDs have full access to everything, regardless of roles or tokens.
    // This resolves all initialization/catch-22 permission issues.
    function isBoss() {
      return request.auth != null && (
        request.auth.uid == '2jnMK761RcMvag3Agj5Wx3HjwpJ2' || 
        request.auth.uid == 'VaGwarisa'
      );
    }
    
    // Global bypass for Bosses
    match /{document=**} {
      allow read, write: if isBoss();
    }
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper to check for a claim (handles potential absence of token/claims)
    function hasClaim(claim) {
      return isSignedIn() && request.auth.token.get(claim, false) == true;
    }
    
    function isSuperAdmin() {
      return isBoss() || hasClaim('super_admin');
    }
    
    function isBureauChief() {
      return isBoss() || hasClaim('bureau_chief') || hasClaim('super_admin');
    }
    
    function isEditor() {
      return isBoss() || hasClaim('editor') || isBureauChief();
    }
    
    function isAdmin() {
      return isBoss() || hasClaim('admin') || isSuperAdmin();
    }
    
    function isWriter() {
      return isBoss() || hasClaim('writer');
    }
    
    function hasAnyStaffRole() {
      return isBoss() || 
             hasClaim('super_admin') || 
             hasClaim('bureau_chief') || 
             hasClaim('admin') || 
             hasClaim('editor') || 
             hasClaim('writer');
    }
    
    function isOwner(resource) {
      return isSignedIn() && (
        request.auth.uid == resource.data.authorId || 
        request.auth.uid == resource.data.uid ||
        request.auth.uid == resource.data.authorUid ||
        request.auth.uid == resource.data.writerId
      );
    }
    
    // --- PUBLIC CONTENT (LEGACY & ROOT) ---
    match /artifacts/{appId}/public/{document=**} {
      allow read: if true;
      allow write: if hasAnyStaffRole();
    }
    
    // --- STAFF COLLECTION ---
    match /staff/{staffId} {
      allow read: if isBoss() || (isSignedIn() && request.auth.uid == staffId) || isBureauChief() || isAdmin();
      allow write: if isBoss() || isBureauChief() || isAdmin();
      allow update: if isBoss() || (isSignedIn() && request.auth.uid == staffId);
    }
    
    // --- WRITERS COLLECTION ---
    match /writers/{writerId} {
      allow read: if isBoss() || isEditor() || isAdmin() || (isSignedIn() && request.auth.uid == writerId);
      allow write: if isBoss() || isEditor() || isAdmin() || (isSignedIn() && request.auth.uid == writerId);
    }
    
    // --- INVITATIONS ---
    match /invites/{inviteId} {
      allow read: if true;
      allow write: if isBoss() || isAdmin() || isBureauChief();
    }
    
    // --- AUDIT LOGS ---
    match /auditLog/{logId} {
      allow read: if isBoss() || isAdmin() || isBureauChief();
      allow create: if isBoss() || hasAnyStaffRole();
      allow update, delete: if isBoss();
    }
    
    // --- SUBSCRIBERS ---
    match /subscribers/{subscriberId} {
      allow read: if isBoss() || isAdmin() || isEditor() || (isSignedIn() && request.auth.uid == subscriberId);
      allow write: if isBoss() || isAdmin() || (isSignedIn() && request.auth.uid == subscriberId);
    }
    
    // --- READERS & USERS ---
    match /users/{userId} {
      allow read: if true;
      allow write: if isBoss() || (isSignedIn() && request.auth.uid == userId);
    }
    
    match /readers/{readerId} {
      allow read: if isBoss() || (isSignedIn() && request.auth.uid == readerId) || isAdmin();
      allow write: if isBoss() || (isSignedIn() && request.auth.uid == readerId);
    }
    
    // --- OPINIONS/ARTICLES (Legacy Path) ---
    match /artifacts/{appId}/public/data/opinions/{opinionId} {
      allow read: if true;
      allow create: if isBoss() || isSignedIn();
      allow update: if isBoss() || (isSignedIn() && (isOwner(resource) || isEditor()));
      allow delete: if isBoss() || isBureauChief();
    }
    
    // --- PITCHES ---
    match /artifacts/{appId}/public/data/pitches/{pitchId} {
      allow read: if isBoss() || (isSignedIn() && (isOwner(resource) || isEditor()));
      allow create: if isBoss() || isWriter() || hasAnyStaffRole();
      allow update, delete: if isBoss() || (isSignedIn() && (isOwner(resource) || isEditor()));
    }
    
    // --- ADS ---
    match /artifacts/{appId}/public/data/ads/{adId} {
      allow read: if true;
      allow create: if isBoss() || isSignedIn();
      allow update: if isBoss() || (isSignedIn() && (isOwner(resource) || isAdmin()));
      allow delete: if isBoss() || isAdmin();
    }
    
    // --- AD IMPRESSIONS & ANALYTICS ---
    match /artifacts/{appId}/public/data/adImpressions/{impressionId} {
      allow read: if isBoss() || isAdmin();
      allow create: if true; // Allow anonymous users to track impressions
    }
    
    match /artifacts/{appId}/public/data/adClicks/{clickId} {
      allow read: if isBoss() || isAdmin();
      allow create: if true; // Allow anonymous users to track clicks
    }
    
    // --- ADVERTISERS ---
    match /artifacts/{appId}/public/data/advertisers/{advertiserId} {
      allow read: if isBoss() || isAdmin() || (isSignedIn() && request.auth.uid == advertiserId);
      allow create: if isBoss() || isSignedIn(); // Allow self-registration
      allow update: if isBoss() || isAdmin() || (isSignedIn() && request.auth.uid == advertiserId);
      allow delete: if isBoss() || isAdmin();
    }

    // --- PAYMENTS & REVENUE ---
    match /paymentStatements/{statementId} {
      allow read: if isBoss() || isAdmin() || isBureauChief() || (isSignedIn() && request.auth.uid == resource.data.writerId);
      allow write: if isBoss() || isAdmin() || isBureauChief();
    }

    // --- ðŸ“Š ANALYTICS & METRICS ---
    match /analytics/daily/{date} {
      allow read: if isSuperAdmin() || isAdmin();
      allow write: if isBoss();
    }
    match /analytics/articles/{articleId} {
      allow read: if isSuperAdmin() || isAdmin();
      allow write: if isBoss();
      allow create, update: if true; // Allow client-side increments (with safety)
    }
    match /analytics/staff/{staffId} {
      allow read: if isSuperAdmin() || isAdmin() || (isSignedIn() && request.auth.uid == staffId);
      allow write: if isBoss();
    }
    match /analytics/{document=**} {
      allow read: if isSuperAdmin() || isAdmin();
      allow write: if isBoss();
    }

    // --- ðŸ”´ LIVE ACTIVITY LOG ---
    match /activityLog/{logId} {
      allow read: if isSuperAdmin() || isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isBoss();
    }

    // --- âš¡ SYSTEM HEALTH & STATUS ---
    match /systemHealth/{metricId} {
      allow read: if isSuperAdmin() || isAdmin();
      allow write: if isBoss();
    }
  }
}