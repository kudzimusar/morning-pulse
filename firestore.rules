rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Role Hierarchy Helper Functions ---
    // These functions create a permission hierarchy:
    // super_admin -> bureau_chief -> admin / editor -> writer

    function isSuperAdmin() {
      return request.auth.token.super_admin == true;
    }

    function isBureauChief() {
      // Bureau chiefs inherit super_admin privileges.
      return request.auth.token.bureau_chief == true || isSuperAdmin();
    }

    function isAdmin() {
      // Admins inherit bureau_chief privileges.
      return request.auth.token.admin == true || isBureauChief();
    }

    function isEditor() {
      // Editors inherit bureau_chief privileges.
      return request.auth.token.editor == true || isBureauChief();
    }

    function isWriter() {
      return request.auth.token.writer == true;
    }

    // --- Collection-Specific Rules ---

    // Staff Collection
    match /staff/{staffId} {
      // Staff can read their own profile. Bureau chiefs and above can read any profile.
      allow read: if request.auth.uid == staffId || isBureauChief();
      
      // Only bureau chiefs and above can modify staff roles.
      allow write: if isBureauChief();
    }

    // Articles/Opinions Collection
    match /artifacts/morning-pulse-app/public/data/opinions/{opinionId} {
      // Anyone can read published content.
      allow read: if resource.data.status == 'published';
      
      // Authors can read their own work, and editors (and above) can read any work.
      allow read: if request.auth.uid == resource.data.authorId || isEditor();
      
      // Authenticated writers can create new drafts.
      allow create: if isWriter() &&
                   request.resource.data.authorId == request.auth.uid &&
                   request.resource.data.status == 'draft';
      
      // Authors can update their own drafts. Editors (and above) can update any document.
      allow update: if isEditor() ||
                   (request.auth.uid == resource.data.authorId && resource.data.status == 'draft');
    }

    // News Collection (Generic)
    match /news/{storyId} {
      // Publicly readable
      allow read: if true;
      // Writers can create
      allow create: if isWriter();
      // Editors and above can update
      allow update: if isEditor();
      // Admins and above can delete
      allow delete: if isAdmin();
    }
  }
}
