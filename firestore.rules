rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================
    // HELPERS
    // ===========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getStaffDoc() {
      // Path must be absolute and point to the specific staff collection
      return get(/databases/$(database)/documents/artifacts/morning-pulse-app/public/data/staff/$(request.auth.uid));
    }

    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/morning-pulse-app/public/data/staff/$(request.auth.uid)) &&
             getStaffDoc().data.roles.hasAny([role]);
    }

    function isAdmin() {
      return hasRole('admin') || hasRole('super_admin');
    }

    function isEditor() {
      return hasRole('editor') || hasRole('admin') || hasRole('super_admin');
    }

    function isAdOps() {
      return hasRole('ad_manager') || hasRole('sales') || hasRole('admin') || hasRole('super_admin');
    }

    // Helper function: Check if user is approved advertiser (requires appId parameter)
    function isApprovedAdvertiser(appId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/advertisers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/artifacts/$(appId)/public/data/advertisers/$(request.auth.uid)).data.status == 'approved';
    }
    
    // ===========================================
    // STAFF COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/staff/{uid} {
      // Anyone authenticated can read staff (for role checks, activity display)
      allow read, list: if isAuthenticated();
      
      // Allow create if:
      // 1. Admin is creating it, OR
      // 2. User is creating their own during signup (from invitation)
      allow create: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.keys().hasAll(['uid', 'email', 'name', 'roles', 'isActive']) &&
                       request.resource.data.uid == uid);
      
      // Only admins can update staff documents
      // Exception: Users can update their own lastActive timestamp
      allow update: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActive', 'updatedAt']));
      
      // Only admins can delete staff
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // INVITATIONS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/invites/{token} {
      // Anyone can read (needed to validate token on join page)
      allow read, list: if true;
      
      // Only admins can create invitations
      allow create: if isAdmin();
      
      // Only admins can update invitations (revoke, mark as used)
      // Exception: System can mark invite as 'used' during signup
      allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       request.resource.data.status == 'used' &&
                       resource.data.status == 'pending');
      
      // Only admins can delete invitations
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // CONTENT
    // ===========================================
    
    // NEWS COLLECTION
    match /artifacts/{appId}/public/data/news/{date} {
      // Public can read and list news
      allow read, list: if true;
      allow write: if isEditor();
    }

    // OPINIONS COLLECTION (Editorial Content)
    match /artifacts/{appId}/public/data/opinions/{opinionId} {
      // Public can read and list published opinions; editors can see all
      // FIX: Allow list for everyone, but filter results in query
      allow read, list: if true;
      
      // ========================================
      // Sprint 6: Content Validation Functions
      // ========================================
      
      // Validate headline: must exist and be at least 5 characters
      function hasValidHeadline(data) {
        return data.keys().hasAny(['headline']) && 
               data.headline is string && 
               data.headline.size() >= 5;
      }
      
      // Validate body: must exist and be at least 50 characters
      function hasValidBody(data) {
        return data.keys().hasAny(['body']) && 
               data.body is string && 
               data.body.size() >= 50;
      }
      
      // Validate authorName: must exist and be at least 2 characters
      function hasValidAuthorName(data) {
        return data.keys().hasAny(['authorName']) && 
               data.authorName is string && 
               data.authorName.size() >= 2;
      }
      
      // Combined content validation for submissions
      function isValidOpinionContent(data) {
        return hasValidHeadline(data) && 
               hasValidBody(data) && 
               hasValidAuthorName(data);
      }
      
      // Writers can create opinions (submissions) with valid content
      allow create: if isAuthenticated() && isValidOpinionContent(request.resource.data);
      
      // Editors can update any opinion; writers can update their own (with valid content)
      allow update: if isEditor() || 
                      (isAuthenticated() && 
                       request.auth.uid == resource.data.authorId && 
                       isValidOpinionContent(request.resource.data));
      
      // Only admins can delete opinions
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // SOCIAL
    // ===========================================
    
    // PUBLIC REACTIONS COLLECTION
    match /artifacts/{appId}/public/data/reactions/{reactionId} {
      allow read, list: if true;
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
      allow update: if false;
    }

    // PUBLIC COMMENTS COLLECTION
    match /artifacts/{appId}/public/data/publicComments/{commentId} {
      allow read, list: if true;
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'active';
      allow update: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
    }
    
    // ===========================================
    // ADVERTISING
    // ===========================================
    
    // ADVERTISERS COLLECTION
    match /artifacts/{appId}/public/data/advertisers/{uid} {
      allow read, list: if request.auth.uid == uid || isAdmin() || isAdOps();
      allow create: if request.auth.uid == uid && request.resource.data.status == 'pending_approval';
      allow update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // ADS COLLECTION
    match /artifacts/{appId}/public/data/ads/{adId} {
      // Public can read ads
      allow read, list: if true;
      allow create: if isApprovedAdvertiser(appId) && request.resource.data.advertiserId == request.auth.uid;
      allow update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // AD SLOTS COLLECTION
    match /artifacts/{appId}/public/data/adSlots/{slotId} {
      allow read, list: if true;
      allow create, update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // AD IMPRESSIONS & CLICKS
    match /artifacts/{appId}/public/data/adImpressions/{impressionId} {
      allow read, list: if isAdmin() || isAdOps();
      allow create: if true;
      allow update, delete: if false;
    }
    match /artifacts/{appId}/public/data/adClicks/{clickId} {
      allow read, list: if isAdmin() || isAdOps();
      allow create: if true;
      allow update, delete: if false;
    }
    
    // ===========================================
    // OTHER COLLECTIONS
    // ===========================================
    
    // WRITERS COLLECTION
    match /artifacts/{appId}/public/data/writers/{uid} {
      allow create: if true;
      allow read, list: if request.auth.uid == uid || isAdmin();
      allow update: if request.auth.uid == uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // STORY PITCHES COLLECTION (Sprint 0)
    // ===========================================
    match /artifacts/{appId}/public/data/storyPitches/{pitchId} {
      // Writers can read their own pitches; editors can read all
      allow read: if isAuthenticated() && 
                    (resource.data.writerId == request.auth.uid || isEditor());
      
      // Editors can list all pitches; writers see filtered by client
      allow list: if isAuthenticated();
      
      // Writers can create pitches
      allow create: if isAuthenticated() && 
                      request.resource.data.writerId == request.auth.uid;
      
      // Writers can update their own drafts; editors can update any pitch
      allow update: if isAuthenticated() && 
                      ((resource.data.writerId == request.auth.uid && 
                        resource.data.status in ['draft', 'submitted', 'rejected']) || 
                       isEditor());
      
      // Writers can delete their own drafts; admins can delete any
      allow delete: if isAuthenticated() && 
                      ((resource.data.writerId == request.auth.uid && 
                        resource.data.status == 'draft') || 
                       isAdmin());
    }
    
    // SHORT LINKS COLLECTION
    match /short_links/{shortId} {
      allow read, list: if true;
      allow create, update: if isEditor();
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // NEWSLETTER SUBSCRIBERS
    // ===========================================
    match /artifacts/{appId}/public/data/subscribers/{subscriberId} {
      // Public can read (needed for unsubscribe pages)
      // Anyone can create (subscribe)
      // Anyone can update (unsubscribe, update preferences)
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // WRITER METRICS COLLECTION (Sprint 3)
    // ===========================================
    // Metrics are computed by Cloud Functions
    // Writers can read their own metrics, admins can read all
    match /artifacts/{appId}/public/data/writerMetrics/{writerId} {
      // Writers can read their own metrics
      allow read: if isAuthenticated() && request.auth.uid == writerId;
      // Editors and admins can read all metrics
      allow read: if isEditor();
      // Cloud Functions use admin SDK for writes
      allow write: if false;
    }
    
    // Allow listing all metrics for editors/admins (leaderboard)
    match /artifacts/{appId}/public/data/writerMetrics/{document=**} {
      allow list: if isEditor();
    }
    
    // ===========================================
    // WRITER PAYMENTS COLLECTION (Sprint 4)
    // ===========================================
    // Payment statements are generated by Cloud Functions
    // Writers can read their own statements, admins can read/manage all
    match /writerPayments/{writerId} {
      // Writers can read their own payment root document
      allow read: if isAuthenticated() && request.auth.uid == writerId;
      // Admins can read all payment documents
      allow read: if isAdmin();
      // Cloud Functions use admin SDK for writes
      allow write: if false;
    }
    
    // Payment statements subcollection
    match /writerPayments/{writerId}/statements/{statementId} {
      // Writers can read their own statements
      allow read: if isAuthenticated() && request.auth.uid == writerId;
      // Admins can read all statements
      allow read: if isAdmin();
      // Only admins can update statement status (mark as paid, approved)
      allow update: if isAdmin();
      // Cloud Functions handle creation (admin SDK)
      allow create, delete: if false;
    }
    
    // Allow listing all payment statements for admins
    match /writerPayments/{writerId}/statements/{document=**} {
      allow list: if isAdmin() || (isAuthenticated() && request.auth.uid == writerId);
    }
    
    // ===========================================
    // ANALYTICS COLLECTION
    // ===========================================
    // Analytics are written by Cloud Functions (admin SDK)
    // Only admins can read analytics
    match /artifacts/{appId}/analytics/{document=**} {
      allow read: if isAdmin();
      // Cloud Functions use admin SDK, so client writes are blocked
      allow write: if false;
    }
    
    // ===========================================
    // AUTO-PUBLISH AUDIT LOG (Sprint 5)
    // ===========================================
    // Audit log for server-side auto-publisher
    // Written by Cloud Functions, readable by admins
    match /autoPublishLog/{logId} {
      allow read: if isAdmin();
      // Cloud Functions use admin SDK for writes
      allow write: if false;
    }
    
    // ===========================================
    // DEFAULT DENY
    // ===========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
