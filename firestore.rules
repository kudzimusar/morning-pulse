rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- ðŸ‘‘ BOSS MODE (Global Bypass) ---
    // These specific UIDs have full access to everything, regardless of roles or tokens.
    // This resolves all initialization/catch-22 permission issues.
    function isBoss() {
      return request.auth != null && (
        request.auth.uid == '2jnMK761RcMvag3Agj5Wx3HjwpJ2' || 
        request.auth.uid == 'VaGwarisa'
      );
    }
    
    match /{document=**} {
      allow read, write: if isBoss();
    }
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.super_admin == true;
    }
    
    function isBureauChief() {
      return isSignedIn() && (
        request.auth.token.bureau_chief == true || 
        request.auth.token.super_admin == true
      );
    }
    
    function isEditor() {
      return isSignedIn() && (
        request.auth.token.editor == true || 
        request.auth.token.bureau_chief == true || 
        request.auth.token.super_admin == true
      );
    }
    
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true || 
        request.auth.token.super_admin == true
      );
    }
    
    function isWriter() {
      return isSignedIn() && request.auth.token.writer == true;
    }
    
    function hasAnyStaffRole() {
      return isSignedIn() && (
        request.auth.token.super_admin == true ||
        request.auth.token.bureau_chief == true ||
        request.auth.token.admin == true ||
        request.auth.token.editor == true ||
        request.auth.token.writer == true
      );
    }
    
    function isOwner(resource) {
      return isSignedIn() && (
        request.auth.uid == resource.data.authorId || 
        request.auth.uid == resource.data.uid ||
        request.auth.uid == resource.data.authorUid
      );
    }
    
    // --- PUBLIC CONTENT (LEGACY & ROOT) ---
    match /artifacts/{appId}/public/{document=**} {
      allow read: if true;
      allow write: if hasAnyStaffRole();
    }
    
    // --- STAFF COLLECTION ---
    match /staff/{staffId} {
      allow read: if (isSignedIn() && request.auth.uid == staffId) || isBureauChief() || isAdmin();
      allow write: if isBureauChief();
      allow update: if isSignedIn() && request.auth.uid == staffId;
    }
    
    // --- WRITERS COLLECTION ---
    match /writers/{writerId} {
      allow read: if isEditor() || isAdmin() || (isSignedIn() && request.auth.uid == writerId);
      allow write: if isEditor() || isAdmin() || (isSignedIn() && request.auth.uid == writerId);
    }
    
    // --- INVITATIONS ---
    match /invites/{inviteId} {
      allow read: if true; // Tokens must be readable to validate
      allow write: if isAdmin() || isBureauChief();
    }
    
    // --- AUDIT LOGS ---
    match /auditLog/{logId} {
      allow read: if isAdmin() || isBureauChief();
      allow create: if hasAnyStaffRole();
      allow update, delete: if false;
    }
    
    // --- SUBSCRIBERS ---
    match /subscribers/{subscriberId} {
      allow read: if isAdmin() || isEditor() || (isSignedIn() && request.auth.uid == subscriberId);
      allow write: if isAdmin() || (isSignedIn() && request.auth.uid == subscriberId);
    }
    
    // --- READERS & USERS ---
    match /users/{userId} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    match /readers/{readerId} {
      allow read: if (isSignedIn() && request.auth.uid == readerId) || isAdmin();
      allow write: if isSignedIn() && request.auth.uid == readerId;
    }
    
    // --- OPINIONS/ARTICLES (Legacy Path) ---
    match /artifacts/{appId}/public/data/opinions/{opinionId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (isOwner(resource) || isEditor());
      allow delete: if isBureauChief();
    }
    
    // --- PITCHES ---
    match /artifacts/{appId}/public/data/pitches/{pitchId} {
      allow read: if isSignedIn() && (isOwner(resource) || isEditor());
      allow create: if isWriter();
      allow update, delete: if isSignedIn() && (isOwner(resource) || isEditor());
    }
    
    // --- ADS ---
    match /artifacts/{appId}/public/data/ads/{adId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (isOwner(resource) || isAdmin());
      allow delete: if isAdmin();
    }
  }
}