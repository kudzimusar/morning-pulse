rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================
    // HELPERS
    // ===========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getStaffDoc() {
      // Path must be absolute and point to the specific staff collection
      return get(/databases/$(database)/documents/artifacts/morning-pulse-app/public/data/staff/$(request.auth.uid));
    }

    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/morning-pulse-app/public/data/staff/$(request.auth.uid)) &&
             getStaffDoc().data.roles.hasAny([role]);
    }

    function isAdmin() {
      return hasRole('admin') || hasRole('super_admin');
    }

    function isEditor() {
      return hasRole('editor') || hasRole('admin') || hasRole('super_admin');
    }

    function isAdOps() {
      return hasRole('ad_manager') || hasRole('sales') || hasRole('admin') || hasRole('super_admin');
    }

    // Helper function: Check if user is approved advertiser (requires appId parameter)
    function isApprovedAdvertiser(appId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/advertisers/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/artifacts/$(appId)/public/data/advertisers/$(request.auth.uid)).data.status == 'approved';
    }
    
    // ===========================================
    // STAFF COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/staff/{uid} {
      // Anyone authenticated can read staff (for role checks, activity display)
      allow read, list: if isAuthenticated();
      
      // Allow create if:
      // 1. Admin is creating it, OR
      // 2. User is creating their own during signup (from invitation)
      allow create: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.keys().hasAll(['uid', 'email', 'name', 'roles', 'isActive']) &&
                       request.resource.data.uid == uid);
      
      // Only admins can update staff documents
      // Exception: Users can update their own lastActive timestamp
      allow update: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActive', 'updatedAt']));
      
      // Only admins can delete staff
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // INVITATIONS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/invites/{token} {
      // Anyone can read (needed to validate token on join page)
      allow read, list: if true;
      
      // Only admins can create invitations
      allow create: if isAdmin();
      
      // Only admins can update invitations (revoke, mark as used)
      // Exception: System can mark invite as 'used' during signup
      allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       request.resource.data.status == 'used' &&
                       resource.data.status == 'pending');
      
      // Only admins can delete invitations
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // CONTENT
    // ===========================================
    
    // NEWS COLLECTION
    match /artifacts/{appId}/public/data/news/{date} {
      // Public can read and list news
      allow read, list: if true;
      allow write: if isEditor();
    }

    // OPINIONS COLLECTION (Editorial Content)
    match /artifacts/{appId}/public/data/opinions/{opinionId} {
      // Public can read and list published opinions; editors can see all
      // FIX: Allow list for everyone, but filter results in query
      allow read, list: if true;
      
      // Writers can create opinions (submissions)
      allow create: if isAuthenticated();
      
      // Only editors can update opinions (review, edit, publish)
      allow update: if isEditor() || (isAuthenticated() && request.auth.uid == resource.data.authorId);
      
      // Only admins can delete opinions
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // SOCIAL
    // ===========================================
    
    // PUBLIC REACTIONS COLLECTION
    match /artifacts/{appId}/public/data/reactions/{reactionId} {
      allow read, list: if true;
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
      allow update: if false;
    }

    // PUBLIC COMMENTS COLLECTION
    match /artifacts/{appId}/public/data/publicComments/{commentId} {
      allow read, list: if true;
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'active';
      allow update: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isEditor();
    }
    
    // ===========================================
    // ADVERTISING
    // ===========================================
    
    // ADVERTISERS COLLECTION
    match /artifacts/{appId}/public/data/advertisers/{uid} {
      allow read, list: if request.auth.uid == uid || isAdmin() || isAdOps();
      allow create: if request.auth.uid == uid && request.resource.data.status == 'pending_approval';
      allow update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // ADS COLLECTION
    match /artifacts/{appId}/public/data/ads/{adId} {
      // Public can read ads
      allow read, list: if true;
      allow create: if isApprovedAdvertiser(appId) && request.resource.data.advertiserId == request.auth.uid;
      allow update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // AD SLOTS COLLECTION
    match /artifacts/{appId}/public/data/adSlots/{slotId} {
      allow read, list: if true;
      allow create, update: if isAdmin() || isAdOps();
      allow delete: if isAdmin();
    }
    
    // AD IMPRESSIONS & CLICKS
    match /artifacts/{appId}/public/data/adImpressions/{impressionId} {
      allow read, list: if isAdmin() || isAdOps();
      allow create: if true;
      allow update, delete: if false;
    }
    match /artifacts/{appId}/public/data/adClicks/{clickId} {
      allow read, list: if isAdmin() || isAdOps();
      allow create: if true;
      allow update, delete: if false;
    }
    
    // ===========================================
    // OTHER COLLECTIONS
    // ===========================================
    
    // WRITERS COLLECTION
    match /artifacts/{appId}/public/data/writers/{uid} {
      allow create: if true;
      allow read, list: if request.auth.uid == uid || isAdmin();
      allow update: if request.auth.uid == uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    // SHORT LINKS COLLECTION
    match /short_links/{shortId} {
      allow read, list: if true;
      allow create, update: if isEditor();
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // DEFAULT DENY
    // ===========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
