rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Get staff document for current user
    function getStaffDoc() {
      return get(/databases/$(database)/documents/staff/$(request.auth.uid));
    }
    
    // Helper function: Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && 
             getStaffDoc().data.roles.hasAny([role]);
    }
    
    // Helper function: Check if user is admin or super_admin
    function isAdmin() {
      return isAuthenticated() && 
             getStaffDoc().data.roles.hasAny(['admin', 'super_admin']);
    }
    
    // Helper function: Check if user is editor, admin, or super_admin
    function isEditor() {
      return isAuthenticated() && 
             getStaffDoc().data.roles.hasAny(['editor', 'admin', 'super_admin']);
    }
    
    // Helper function: Check if staff account is active
    function isActiveStaff() {
      return isAuthenticated() && 
             getStaffDoc().data.isActive == true;
    }
    
    // ===========================================
    // STAFF COLLECTION (Nested Path)
    // ===========================================
    match /artifacts/{appId}/public/data/staff/{uid} {
      // Anyone authenticated can read staff (for role checks, activity display)
      allow read: if isAuthenticated();
      
      // Allow create if:
      // 1. Admin is creating it, OR
      // 2. User is creating their own during signup (from invitation)
      allow create: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.keys().hasAll(['uid', 'email', 'name', 'roles', 'isActive']) &&
                       request.resource.data.uid == uid);
      
      // Only admins can update staff documents
      // Exception: Users can update their own lastActive timestamp
      allow update: if isAdmin() || 
                      (request.auth.uid == uid && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActive', 'updatedAt']));
      
      // Only admins can delete staff
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // STAFF COLLECTION (Root Level - Backward Compatibility)
    // ===========================================
    match /staff/{uid} {
      // Allow read for backward compatibility
      allow read: if isAuthenticated();
      // Deny writes at root level (use nested path)
      allow write: if false;
    }
    
    // ===========================================
    // INVITATIONS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/invites/{token} {
      // Anyone can read (needed to validate token on join page)
      allow read: if true;
      
      // Only admins can create invitations
      allow create: if isAdmin();
      
      // Only admins can update invitations (revoke, mark as used)
      // Exception: System can mark invite as 'used' during signup
      allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       request.resource.data.status == 'used' &&
                       resource.data.status == 'pending');
      
      // Only admins can delete invitations
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // AUDIT LOGS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Any authenticated user can create audit logs
      // (Services log actions on behalf of users)
      allow create: if isAuthenticated();
      
      // Audit logs cannot be updated or deleted (immutable)
      allow update: if false;
      allow delete: if false;
    }
    
    // ===========================================
    // OPINIONS COLLECTION (Editorial Content)
    // ===========================================
    match /artifacts/{appId}/public/data/opinions/{opinionId} {
      // Public can read published opinions
      allow read: if resource.data.status == 'published' || isEditor();
      
      // Writers can create opinions (submissions)
      allow create: if isAuthenticated();
      
      // Only editors can update opinions (review, edit, publish)
      allow update: if isEditor();
      
      // Only admins can delete opinions
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // WRITERS COLLECTION
    // ===========================================
    match /writers/{uid} {
      // Anyone can create writer applications
      allow create: if true;
      
      // Writers can read their own document
      // Admins can read all writer documents
      allow read: if request.auth.uid == uid || isAdmin();
      
      // Writers can update their own profile
      // Admins can update any writer (approve/reject)
      allow update: if request.auth.uid == uid || isAdmin();
      
      // Only admins can delete writers
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // SHORT LINKS COLLECTION
    // ===========================================
    match /short_links/{shortId} {
      // Public can read short links (needed for redirects if done client-side, 
      // but here Cloud Function handles it with admin privileges)
      allow read: if true;
      
      // Only editors can create or update short links
      allow create, update: if isEditor();
      
      // Only admins can delete short links
      allow delete: if isAdmin();
    }

    // ===========================================
    // PUBLIC REACTIONS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/reactions/{reactionId} {
      // Public can read all reactions (for displaying counts)
      allow read: if true;
      
      // Any authenticated user (including anonymous) can create reactions
      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll(['opinionId', 'userId', 'type', 'createdAt']) &&
                      request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own reactions (toggle off)
      // Editors can delete any reaction (moderation)
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                      isEditor();
      
      // Reactions cannot be updated (only create/delete)
      allow update: if false;
    }

    // ===========================================
    // PUBLIC COMMENTS COLLECTION
    // ===========================================
    match /artifacts/{appId}/public/data/publicComments/{commentId} {
      // Public can read active comments
      allow read: if resource.data.status == 'active' || isEditor();
      
      // Any authenticated user (including anonymous) can create comments
      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll(['opinionId', 'userId', 'authorName', 'content', 'status', 'createdAt', 'updatedAt']) &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'active' &&
                      request.resource.data.likes == 0 &&
                      request.resource.data.isEdited == false;
      
      // Users can update their own comments (edit content)
      // Editors can update any comment (moderation, replies)
      allow update: if (isAuthenticated() && 
                         resource.data.userId == request.auth.uid &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'isEdited', 'updatedAt'])) ||
                      isEditor();
      
      // Users can soft-delete their own comments
      // Editors can delete any comment (moderation)
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                      isEditor();
    }

    // ===========================================
    // DEFAULT DENY
    // ===========================================
    // All other paths are denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
